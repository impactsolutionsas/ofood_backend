generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum Role {
  CLIENT
  RESTAURANT_OWNER
  ADMIN
  COURIER
}

enum DishCategory {
  BREAKFAST
  LUNCH
  DINNER
  DESSERT
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum OrderStatus {
  PENDING
  AWAITING_PAYMENT
  PAID
  PREPARING
  READY
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum DeliveryStatus {
  PENDING
  SEARCHING
  ASSIGNED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum DeliveryVehicle {
  MOTO
  VELO
  VOITURE
}

enum WalletTransactionType {
  RECHARGE
  DEBIT_ORDER
  REFUND
  BONUS
  CASHOUT
}

enum WalletTransactionStatus {
  PENDING
  SUCCESS
  FAILED
  REVERSED
}

enum NotificationCategory {
  ORDER_UPDATE
  DELIVERY_UPDATE
  PAYMENT
  PROMO
  SYSTEM
}

enum PaymentMethod {
  WAVE
  ORANGE_MONEY
  FREE_MONEY
  CASH_ON_DELIVERY
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

// ─── Models ──────────────────────────────────────────────

model User {
  id         String      @id @default(uuid())
  firstName  String
  lastName   String
  phone      String      @unique
  email      String?     @unique
  pinHash    String
  role       Role        @default(CLIENT)
  isActive   Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  restaurant        Restaurant?
  orders            Order[]
  ratings           Rating[]
  otpCodes          OtpCode[]
  wallet            Wallet?
  courier           Courier?
  pushSubscriptions PushSubscription[]
  notificationLogs  NotificationLog[]

  @@map("users")
}

model OtpCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("otp_codes")
}

model Restaurant {
  id            String        @id @default(uuid())
  ownerId       String        @unique
  name          String
  logoUrl       String
  address       String
  lat           Float
  lng           Float
  description   String
  avgRating     Float         @default(0)
  totalRatings  Int           @default(0)
  isOpen        Boolean       @default(false)
  avgPrepTime   Int           @default(20)
  dailyCapacity String
  isVerified    Boolean       @default(false)
  walletBalance Float         @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  owner         User          @relation(fields: [ownerId], references: [id])
  dishes        Dish[]
  menus         Menu[]
  orderItems    OrderItem[]
  transactions  Transaction[]
  ratings       Rating[]

  @@map("restaurants")
}

model Dish {
  id           String       @id @default(uuid())
  restaurantId String
  name         String
  description  String?
  price        Float
  photoUrl     String?
  category     DishCategory
  isAvailable  Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  restaurant   Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems    MenuItem[]
  orderItems   OrderItem[]

  @@map("dishes")
}

model Menu {
  id           String     @id @default(uuid())
  restaurantId String
  dayOfWeek    DayOfWeek
  date         DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  items        MenuItem[]

  @@unique([restaurantId, dayOfWeek])
  @@map("menus")
}

model MenuItem {
  id          String  @id @default(uuid())
  menuId      String
  dishId      String
  isAvailable Boolean @default(true)
  createdAt   DateTime @default(now())
  menu        Menu     @relation(fields: [menuId], references: [id], onDelete: Cascade)
  dish        Dish     @relation(fields: [dishId], references: [id], onDelete: Cascade)

  @@unique([menuId, dishId])
  @@map("menu_items")
}

model Order {
  id                String              @id @default(uuid())
  userId            String
  status            OrderStatus         @default(PENDING)
  totalAmount       Float
  paymentStatus     String              @default("UNPAID")
  paymentMethod     PaymentMethod?
  paymentRef        String?
  paidFromWallet    Boolean             @default(false)
  walletAmountUsed  Float?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  user              User                @relation(fields: [userId], references: [id])
  items             OrderItem[]
  transactions      Transaction[]
  walletTransactions WalletTransaction[]
  rating            Rating?
  delivery          Delivery?

  @@map("orders")
}

model OrderItem {
  id           String     @id @default(uuid())
  orderId      String
  dishId       String
  restaurantId String
  quantity     Int
  unitPrice    Float
  subtotal     Float
  order        Order      @relation(fields: [orderId], references: [id], onDelete: Cascade)
  dish         Dish       @relation(fields: [dishId], references: [id])
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  @@map("order_items")
}

model Transaction {
  id             String            @id @default(uuid())
  orderId        String?
  restaurantId   String?
  type           TransactionType
  amount         Float
  mobileProvider PaymentMethod?
  phoneNumber    String?
  reference      String?
  status         TransactionStatus @default(PENDING)
  note           String?
  createdAt      DateTime          @default(now())
  order          Order?            @relation(fields: [orderId], references: [id])
  restaurant     Restaurant?       @relation(fields: [restaurantId], references: [id])

  @@map("transactions")
}

model Rating {
  id           String     @id @default(uuid())
  orderId      String     @unique
  userId       String
  restaurantId String
  stars        Int
  comment      String?
  createdAt    DateTime   @default(now())
  order        Order      @relation(fields: [orderId], references: [id])
  user         User       @relation(fields: [userId], references: [id])
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])

  @@map("ratings")
}

// ─── Phase 2 Models ─────────────────────────────────────

model Wallet {
  id           String              @id @default(uuid())
  userId       String              @unique
  balance      Float               @default(0)
  frozenAmount Float               @default(0)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  user         User                @relation(fields: [userId], references: [id])
  transactions WalletTransaction[]

  @@map("wallets")
}

model WalletTransaction {
  id            String                  @id @default(uuid())
  walletId      String
  orderId       String?
  type          WalletTransactionType
  amount        Float
  balanceBefore Float
  balanceAfter  Float
  status        WalletTransactionStatus @default(PENDING)
  reference     String?
  note          String?
  createdAt     DateTime                @default(now())
  wallet        Wallet                  @relation(fields: [walletId], references: [id])
  order         Order?                  @relation(fields: [orderId], references: [id])

  @@map("wallet_transactions")
}

model Courier {
  id            String             @id @default(uuid())
  userId        String             @unique
  vehicle       DeliveryVehicle
  plateNumber   String?
  idCardUrl     String
  selfieUrl     String
  isVerified    Boolean            @default(false)
  isOnline      Boolean            @default(false)
  currentLat    Float?
  currentLng    Float?
  walletBalance Float              @default(0)
  avgRating     Float              @default(0)
  totalRatings  Int                @default(0)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  user          User               @relation(fields: [userId], references: [id])
  deliveries    Delivery[]
  transactions  CourierTransaction[]

  @@map("couriers")
}

model Delivery {
  id               String             @id @default(uuid())
  orderId          String             @unique
  courierId        String?
  status           DeliveryStatus     @default(PENDING)
  pickupLat        Float
  pickupLng        Float
  dropoffLat       Float
  dropoffLng       Float
  distanceKm       Float?
  deliveryFee      Float?
  courierShare     Float?
  platformShare    Float?
  confirmationCode String?
  proofPhotoUrl    String?
  assignedAt       DateTime?
  pickedUpAt       DateTime?
  deliveredAt      DateTime?
  cancelledAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  order            Order              @relation(fields: [orderId], references: [id])
  courier          Courier?           @relation(fields: [courierId], references: [id])
  locations        DeliveryLocation[]

  @@map("deliveries")
}

model DeliveryLocation {
  id         String   @id @default(uuid())
  deliveryId String
  lat        Float
  lng        Float
  speed      Float?
  recordedAt DateTime @default(now())
  delivery   Delivery @relation(fields: [deliveryId], references: [id], onDelete: Cascade)

  @@map("delivery_locations")
}

model CourierTransaction {
  id         String            @id @default(uuid())
  courierId  String
  deliveryId String?
  type       TransactionType
  amount     Float
  status     TransactionStatus @default(PENDING)
  note       String?
  createdAt  DateTime          @default(now())
  courier    Courier           @relation(fields: [courierId], references: [id])

  @@map("courier_transactions")
}

model PushSubscription {
  id        String   @id @default(uuid())
  userId    String
  endpoint  String   @unique
  p256dhKey String
  authKey   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("push_subscriptions")
}

model NotificationLog {
  id        String               @id @default(uuid())
  userId    String
  category  NotificationCategory
  title     String
  body      String
  data      Json?
  isRead    Boolean              @default(false)
  createdAt DateTime             @default(now())
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_logs")
}
